<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="my_robot">

    <!--
        Modell: enkel diff-drive plattform med kropp + to drivhjul + støttehjul + gimbal.
        Fokus: robust og lett-redigerbar kinematisk modell for RViz/Gazebo,
        med enkel kollisjon og inertialer som fungerer for fysikksimulering.
    -->

    <!-- ===================== -->
    <!-- 1) Preconfigs (farger, inertial, osv.) -->
    <!-- ===================== -->

    <!-- Inerti-makroer legges inn her for at denne filen skal være selvstendig i preview/verktøy. -->
    <xacro:macro name="inertial_sphere" params="mass radius *origin">
        <inertial>
            <xacro:insert_block name="origin"/>
            <mass value="${mass}"/>
            <inertia
                ixx="${(2/5) * mass * (radius*radius)}" ixy="0.0" ixz="0.0"
                iyy="${(2/5) * mass * (radius*radius)}" iyz="0.0"
                izz="${(2/5) * mass * (radius*radius)}"/>
        </inertial>
    </xacro:macro>

    <xacro:macro name="inertial_box" params="mass x y z *origin">
        <inertial>
            <xacro:insert_block name="origin"/>
            <mass value="${mass}"/>
            <inertia
                ixx="${(1/12) * mass * (y*y+z*z)}" ixy="0.0" ixz="0.0"
                iyy="${(1/12) * mass * (x*x+z*z)}" iyz="0.0"
                izz="${(1/12) * mass * (x*x+y*y)}"/>
        </inertial>
    </xacro:macro>

    <xacro:macro name="inertial_cylinder" params="mass length radius *origin">
        <inertial>
            <xacro:insert_block name="origin"/>
            <mass value="${mass}"/>
            <inertia
                ixx="${(1/12) * mass * (3*radius*radius + length*length)}" ixy="0.0" ixz="0.0"
                iyy="${(1/12) * mass * (3*radius*radius + length*length)}" iyz="0.0"
                izz="${(1/2) * mass * (radius*radius)}"/>
        </inertial>
    </xacro:macro>

    <!-- Materialer brukes kun for visuell tydelighet i RViz/preview. -->

    <material name="white">
        <color rgba="1 1 1 1"/>
    </material>

    <material name="orange">
        <color rgba="1 0.5 0 1"/>
    </material>

    <material name="blue">
        <color rgba="0 0 1 1"/>
    </material> 

    <material name="black">
        <color rgba="0 0 0 1"/>
    </material> 

    <!-- ===================== -->
    <!-- 2) Main body + gimbal + box -->
    <!-- ===================== -->

    <!-- Referanserammer / struktur
         base_link holdes som rotlink for TF-treet. Kroppen er et fast ledd fra base_link. -->

    <link name="base_link"/>

    <joint name="kropp_joint" type="fixed">
        <parent link="base_link"/>
        <child link="kropp"/>
        <!-- Offset for kropp ift. base_link (brukes til å finjustere modellens referansepunkt). -->
        <origin xyz="0 0.25 0"/>
    </joint>

    <link name="kropp">
        <!-- Kropp: visuell geometri og kollisjon holdes identiske (en boks) for stabil og rask simulering.
             Inertial beregnes via xacro-makro for konsistens når dimensjoner endres. -->
        <visual>
            <origin xyz="0.0 0.0 0.0"/>
            <geometry>
                <box size="0.2 0.3 0.1"/>
            </geometry>
            <material name="white"/>
        </visual>
        <collision>
            <origin xyz="0.0 0.0 0.0"/>
            <geometry>
                <box size="0.2 0.3 0.1"/>
            </geometry>
        </collision>
        <xacro:inertial_box mass="0.5" x="0.2" y="0.3" z="0.1">
            <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:inertial_box>
    </link>

    <!-- Gimbal ("gimble")
         Ønsket: blå stand er fast, og orange boks roterer (yaw rundt Z, pitch rundt X). -->

    <joint name="gimble_stand_joint" type="fixed">
        <parent link="kropp"/>
        <child link="gimble_stand"/>
        <!-- kropp er 0.1 høy (±0.05). Stand er 0.1 lang (±0.05). Senter på stand plasseres derfor på z=0.10. -->
        <origin xyz="0 0 0.10" rpy="0 0 0"/>
    </joint>

    <link name="gimble_stand">
        <visual>
            <geometry>
                <cylinder radius="0.02" length="0.1"/>  
            </geometry>
            <material name="blue"/>
        </visual>
        <collision>
            <geometry>
                <cylinder radius="0.02" length="0.1"/>
            </geometry>
        </collision>
        <xacro:inertial_cylinder mass="0.1" length="0.1" radius="0.02">
            <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:inertial_cylinder>
    </link>

    <joint name="gimble_yaw_joint" type="continuous">
        <parent link="gimble_stand"/>
        <child link="gimble_yaw"/>
        <!-- Pivot på toppen av stand (stand topp = +0.05 i stand-rammen). -->
        <origin xyz="0 0 0.05" rpy="0 0 0"/>
        <axis xyz="0 0 1"/>
        <limit effort="1.0" velocity="1.0"/>
    </joint>

    <link name="gimble_yaw">
        <xacro:inertial_sphere mass="0.01" radius="0.01">
            <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:inertial_sphere>
    </link>

    <!-- Pitch begrenses til ±15 grader. -->
    <joint name="gimble_pitch_joint" type="revolute">
        <parent link="gimble_yaw"/>
        <child link="lidar"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <axis xyz="1 0 0"/>
        <limit effort="1.0" velocity="1.0" lower="-0.261799" upper="0.261799"/>
    </joint>

    <link name="lidar">
        <visual>
            <!-- Løft boksen litt opp slik at rotasjon skjer i bunn av boksen. -->
            <origin xyz="0 0 0.0125" rpy="0 0 0"/>
            <geometry>
                <!-- Skalert kopi av kropp-boksen (0.2 0.3 0.1) i 1/4 størrelse. -->
                <box size="0.05 0.075 0.025"/>
            </geometry>
            <material name="orange"/>
        </visual>
        <collision>
            <origin xyz="0 0 0.0125" rpy="0 0 0"/>
            <geometry>
                <box size="0.05 0.075 0.025"/>
            </geometry>
        </collision>
        <xacro:inertial_box mass="0.1" x="0.05" y="0.075" z="0.025">
            <origin xyz="0 0 0.0125" rpy="0 0 0"/>
        </xacro:inertial_box>
    </link>

    <!-- ===================== -->
    <!-- 3) Wheels (drivhjul + støttehjul/caster) -->
    <!-- ===================== -->

    <!-- Drivsystem (diff-drive)
         Hjulene modelleres som sylindre med enkel sylinder-kollisjon. Dette gir forutsigbar kontaktflate i Gazebo.
         'continuous' gjør at de kan rotere fritt; i praksis styres de typisk via ros2_control. -->

    <joint name="venstre_hjul_joint" type="continuous">
        <parent link="kropp"/>
        <child link="venstre_hjul"/>
        <origin xyz="-0.1025 0.0 -0.05"/>
        <axis xyz="1 0 0"/>
        <limit effort="1.0" velocity="10.0"/>
    </joint>

    <link name="venstre_hjul">
        <visual>
            <origin rpy="1.57079632679 0 1.57079632679"/>
            <geometry>
                <cylinder radius="0.035" length="0.005"/>
            </geometry>
            <material name="black"/>
        </visual>
        <collision>
            <origin rpy="1.57079632679 0 1.57079632679"/>
            <geometry>
                <cylinder radius="0.035" length="0.005"/>
            </geometry>
        </collision>
        <xacro:inertial_cylinder mass="0.1" length="0.005" radius="0.035">
            <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:inertial_cylinder>
    </link>

    <joint name="høyre_hjul_joint" type="continuous">
        <parent link="kropp"/>
        <child link="høyre_hjul"/>
        <origin xyz="0.1025 0 -0.05"/>
        <axis xyz="1 0 0"/>
        <limit effort="1.0" velocity="10.0"/>
    </joint>

    <link name="høyre_hjul">
        <visual>
            <origin rpy="1.57079632679 0 1.57079632679"/>
            <geometry>
                <cylinder radius="0.035" length="0.005"/>
            </geometry>
            <material name="black"/>
        </visual>
        <collision>
            <origin rpy="1.57079632679 0 1.57079632679"/>
            <geometry>
                <cylinder radius="0.035" length="0.005"/>
            </geometry>
        </collision>
        <xacro:inertial_cylinder mass="0.1" length="0.005" radius="0.035">
            <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:inertial_cylinder>
    </link>

    <!-- Støttehjul (caster)
         For en enkel plattform brukes et fast montert "kulehjul" (sphere) for stabil støtte.
         Plasser Z slik at støttehjulet berører bakken på samme høyde som drivhjulene. -->

    <joint name="cast_hjul_joint" type="fixed">
        <parent link="kropp"/>
        <child link="cast_hjul"/>
        <origin xyz="0 -0.12 -0.055"/>
    </joint>

    <link name="cast_hjul">
        <visual>
            <geometry>
                <sphere radius="0.03"/>
            </geometry>
            <material name="black"/>
        </visual>
        <collision>
            <geometry>
                <sphere radius="0.03"/>
            </geometry>
        </collision>
        <xacro:inertial_sphere mass="0.1" radius="0.03">
            <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:inertial_sphere>
    </link>

</robot>